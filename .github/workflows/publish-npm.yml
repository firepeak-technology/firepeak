name: Publish

on:
  push:
    tags:
      - v*

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: nrwl/nx-set-shas@v3
      - run: npm ci

      - run: npx nx workspace-lint
      - run: npx nx run-many --target=lint --parallel=3 --all
      - run: npx nx run-many --target=test --parallel=3 --all ---ci --code-coverage
      - run: npx nx run-many --target=build --parallel=3 --all --prod

      - name: Publish components (Github packages)
        run: |
          for LIBRARY in $(yarn nx affected:libs --base=$last_version --head=$current_version --plain | awk 'NR > 2 && $1 != "Done" { print $1 }')
          do
            cd ./dist/libs/$LIBRARY
            npm publish --registry https://npm.pkg.github.com --no-git-tag-version --no-push --yes
            cd ..
            cd ..
          done
        env:
          GITHUB_TOKEN: ${{ secrets.NPM_TOKEN }}
